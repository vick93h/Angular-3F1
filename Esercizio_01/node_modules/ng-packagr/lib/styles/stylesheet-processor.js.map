{"version":3,"file":"stylesheet-processor.js","sourceRoot":"","sources":["../../../src/lib/styles/stylesheet-processor.ts"],"names":[],"mappings":"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","sourcesContent":["import autoprefixer from 'autoprefixer';\nimport browserslist from 'browserslist';\nimport { existsSync } from 'fs';\nimport { dirname, extname, join, relative } from 'path';\nimport postcss from 'postcss';\nimport postcssUrl from 'postcss-url';\nimport { pathToFileURL } from 'url';\nimport { EsbuildExecutor } from '../esbuild/esbuild-executor';\nimport { generateKey, readCacheEntry, saveCacheEntry } from '../utils/cache';\nimport * as log from '../utils/log';\n\nexport enum CssUrl {\n  inline = 'inline',\n  none = 'none',\n}\n\nexport interface Result {\n  css: string;\n  warnings: string[];\n  error?: string;\n}\nexport class StylesheetProcessor {\n  private browserslistData: string[];\n  private targets: string[];\n  private postCssProcessor: ReturnType<typeof postcss>;\n  private esbuild = new EsbuildExecutor();\n  private styleIncludePaths: string[];\n  private readonly nodeModulesDirs = [];\n\n  constructor(\n    private readonly projectBasePath: string,\n    private readonly basePath: string,\n    private readonly cssUrl?: CssUrl,\n    private readonly includePaths?: string[],\n    private cacheDirectory?: string | false,\n  ) {\n    log.debug(`determine browserslist for ${this.basePath}`);\n    // By default, browserslist defaults are too inclusive\n    // https://github.com/browserslist/browserslist/blob/83764ea81ffaa39111c204b02c371afa44a4ff07/index.js#L516-L522\n\n    // We change the default query to browsers that Angular support.\n    // https://angular.io/guide/browser-support\n    (browserslist.defaults as string[]) = [\n      'last 1 Chrome version',\n      'last 1 Firefox version',\n      'last 2 Edge major versions',\n      'last 2 Safari major versions',\n      'last 2 iOS major versions',\n      'Firefox ESR',\n    ];\n\n    this.styleIncludePaths = [...this.includePaths];\n    let prevDir = null;\n    let currentDir = this.basePath;\n\n    while (currentDir !== prevDir) {\n      const p = join(currentDir, 'node_modules');\n      if (existsSync(p)) {\n        this.styleIncludePaths.push(p);\n        this.nodeModulesDirs.push(p);\n      }\n\n      prevDir = currentDir;\n      currentDir = dirname(prevDir);\n    }\n\n    this.browserslistData = browserslist(undefined, { path: this.basePath });\n    this.targets = transformSupportedBrowsersToTargets(this.browserslistData);\n    this.postCssProcessor = this.createPostCssPlugins();\n  }\n\n  async process({ filePath, content }: { filePath: string; content: string }): Promise<string> {\n    let key: string | undefined;\n\n    if (!content.includes('@import') && !content.includes('@use') && this.cacheDirectory) {\n      // No transitive deps, we can cache more aggressively.\n      key = await generateKey(content, ...this.browserslistData);\n      const result = await readCacheEntry(this.cacheDirectory, key);\n      if (result) {\n        result.warnings.forEach(msg => log.warn(msg));\n\n        return result.css;\n      }\n    }\n\n    // Render pre-processor language (sass, styl, less)\n    const renderedCss = await this.renderCss(filePath, content);\n\n    // We cannot cache CSS re-rendering phase, because a transitive dependency via (@import) can case different CSS output.\n    // Example a change in a mixin or SCSS variable.\n    if (!key) {\n      key = await generateKey(renderedCss, ...this.browserslistData);\n    }\n\n    if (this.cacheDirectory) {\n      const cachedResult = await readCacheEntry(this.cacheDirectory, key);\n      if (cachedResult) {\n        cachedResult.warnings.forEach(msg => log.warn(msg));\n\n        return cachedResult.css;\n      }\n    }\n    // Render postcss (autoprefixing and friends)\n    const result = await this.postCssProcessor.process(renderedCss, {\n      from: filePath,\n      to: filePath.replace(extname(filePath), '.css'),\n    });\n\n    const warnings = result.warnings().map(w => w.toString());\n    const { code, warnings: esBuildWarnings } = await this.esbuild.transform(result.css, {\n      loader: 'css',\n      minify: true,\n      target: this.targets,\n      sourcefile: filePath,\n    });\n\n    if (esBuildWarnings.length > 0) {\n      warnings.push(...(await this.esbuild.formatMessages(esBuildWarnings, { kind: 'warning' })));\n    }\n\n    if (this.cacheDirectory) {\n      await saveCacheEntry(\n        this.cacheDirectory,\n        key,\n        JSON.stringify({\n          css: code,\n          warnings,\n        }),\n      );\n    }\n    warnings.forEach(msg => log.warn(msg));\n\n    return code;\n  }\n\n  private createPostCssPlugins(): ReturnType<typeof postcss> {\n    const postCssPlugins = [];\n    const tailwinds = getTailwindPlugin(this.projectBasePath);\n    if (tailwinds) {\n      postCssPlugins.push(tailwinds);\n      this.cacheDirectory = false;\n    }\n\n    if (this.cssUrl !== CssUrl.none) {\n      postCssPlugins.push(postcssUrl({ url: this.cssUrl }));\n    }\n\n    postCssPlugins.push(\n      autoprefixer({\n        ignoreUnknownVersions: true,\n        overrideBrowserslist: this.browserslistData,\n      }),\n    );\n\n    return postcss(postCssPlugins);\n  }\n\n  private async renderCss(filePath: string, css: string): Promise<string> {\n    const ext = extname(filePath);\n\n    switch (ext) {\n      case '.sass':\n      case '.scss': {\n        return (await import('sass')).compileString(css, {\n          url: pathToFileURL(filePath),\n          syntax: '.sass' === ext ? 'indented' : 'scss',\n          loadPaths: this.styleIncludePaths,\n        }).css;\n      }\n      case '.less': {\n        const { css: content } = await (\n          await import('less')\n        ).default.render(css, {\n          filename: filePath,\n          math: 'always',\n          javascriptEnabled: true,\n          paths: this.styleIncludePaths,\n        });\n\n        return content;\n      }\n\n      case '.css':\n      default:\n        return css;\n    }\n  }\n}\n\nfunction transformSupportedBrowsersToTargets(supportedBrowsers: string[]): string[] {\n  const transformed: string[] = [];\n\n  // https://esbuild.github.io/api/#target\n  const esBuildSupportedBrowsers = new Set(['safari', 'firefox', 'edge', 'chrome', 'ios']);\n\n  for (const browser of supportedBrowsers) {\n    let [browserName, version] = browser.split(' ');\n\n    // browserslist uses the name `ios_saf` for iOS Safari whereas esbuild uses `ios`\n    if (browserName === 'ios_saf') {\n      browserName = 'ios';\n    }\n\n    // browserslist uses ranges `15.2-15.3` versions but only the lowest is required\n    // to perform minimum supported feature checks. esbuild also expects a single version.\n    [version] = version.split('-');\n\n    if (esBuildSupportedBrowsers.has(browserName)) {\n      if (browserName === 'safari' && version === 'TP') {\n        // esbuild only supports numeric versions so `TP` is converted to a high number (999) since\n        // a Technology Preview (TP) of Safari is assumed to support all currently known features.\n        version = '999';\n      }\n\n      transformed.push(browserName + version);\n    }\n  }\n\n  return transformed.length ? transformed : undefined;\n}\n\nfunction getTailwindPlugin(projectBasePath: string) {\n  // Attempt to setup Tailwind CSS\n  // Only load Tailwind CSS plugin if configuration file was found.\n  // This acts as a guard to ensure the project actually wants to use Tailwind CSS.\n  // The package may be unknowningly present due to a third-party transitive package dependency.\n  const tailwindConfigPath = getTailwindConfigPath(projectBasePath);\n  if (tailwindConfigPath) {\n    let tailwindPackagePath;\n    try {\n      tailwindPackagePath = require.resolve('tailwindcss', { paths: [projectBasePath] });\n    } catch {\n      const relativeTailwindConfigPath = relative(projectBasePath, tailwindConfigPath);\n      log.warn(\n        `Tailwind CSS configuration file found (${relativeTailwindConfigPath})` +\n          ` but the 'tailwindcss' package is not installed.` +\n          ` To enable Tailwind CSS, please install the 'tailwindcss' package.`,\n      );\n    }\n    if (tailwindPackagePath) {\n      return require(tailwindPackagePath)({ config: tailwindConfigPath });\n    }\n  }\n}\n\nfunction getTailwindConfigPath(projectRoot: string): string | undefined {\n  // A configuration file can exist in the project or workspace root\n  // The list of valid config files can be found:\n  // https://github.com/tailwindlabs/tailwindcss/blob/8845d112fb62d79815b50b3bae80c317450b8b92/src/util/resolveConfigPath.js#L46-L52\n  const tailwindConfigFiles = ['tailwind.config.js', 'tailwind.config.cjs'];\n  for (const configFile of tailwindConfigFiles) {\n    // Irrespective of the name project level configuration should always take precedence.\n    const fullPath = join(projectRoot, configFile);\n    if (existsSync(fullPath)) {\n      return fullPath;\n    }\n  }\n\n  return undefined;\n}\n"]}